# 插件安装脚本文档

## 插件配置文件 (.config)

每个插件需要一个 `.config` 文件来描述插件信息：

```json
{
  "plugin_code": "my_plugin",
  "plugin_name": "我的插件",
  "plugin_describe": "这是一个示例插件",
  "plugin_version": "1.0.0",
  "author": "开发者名称",
  "github": "https://github.com/xxx/xxx",
  "support_ABI": ["arm64-v8a", "armeabi-v7a"]
}
```

**字段说明：**
| 字段 | 必填 | 说明 |
|------|------|------|
| `plugin_code` | 是 | 插件唯一标识符 |
| `plugin_name` | 是 | 插件显示名称 |
| `plugin_describe` | 否 | 插件描述 |
| `plugin_version` | 是 | 版本号 |
| `author` | 否 | 作者名称（不填显示"匿名"） |
| `github` | 否 | GitHub 仓库地址 |
| `support_ABI` | 否 | 支持的 ABI 架构列表 |

---

## 安装脚本文件 (.install)

插件可以通过 `.install` 文件定义安装流程，支持弹窗提示、用户输入、条件判断等功能。

## 文件结构

```json
{
  "install_before": [...],  // 安装前执行（解压前）
  "install_start": [...],   // 安装中执行（解压后）
  "install_after": [...]    // 安装后执行
}
```

每个阶段包含一个节点数组，按顺序执行。

---

## 内置变量

在任何文本中都可以使用 `${变量名}` 引用变量：

| 变量 | 说明 |
|------|------|
| `${plugin_path}` | 当前插件安装目录 |
| `${plugin_name}` | 插件目录名 |
| `${files_dir}` | 应用 files 目录 |
| `${cache_dir}` | 应用缓存目录 |
| `${current_file}` | 当前编辑器打开的文件路径（仅 Hook 中可用） |
| `${current_dir}` | 当前编辑器文件所在目录（仅 Hook 中可用） |

---

## 节点类型

### 1. alert - 弹窗提示

显示一个提示对话框，用户点击确定后继续。

```json
{
  "node": "alert",
  "title": "安装提示",
  "message": "即将开始安装，请耐心等待"
}
```

**参数：**
- `title` - 对话框标题
- `message` - 提示内容（支持 `\n` 换行）

---

### 2. create_value - 创建变量

创建一个变量，供后续节点使用。

```json
{
  "node": "create_value",
  "name": "theme",
  "type": "string",
  "value": "dark"
}
```

**参数：**
- `name` - 变量名
- `type` - 类型：`string`、`bool`、`int`
- `value` - 初始值（可选）

---

### 3. edit - 输入框

弹出输入框，让用户输入内容，结果保存到变量。

```json
{
  "node": "edit",
  "title": "设置昵称",
  "hint": "请输入你的昵称",
  "target": "nickname",
  "default": "用户"
}
```

**参数：**
- `title` - 对话框标题
- `hint` - 输入框提示文字
- `target` - 保存到哪个变量
- `default` - 默认值（可选）

---

### 4. select - 选择框

弹出选择框，支持单选和多选。

**单选示例：**
```json
{
  "node": "select",
  "title": "选择主题",
  "items": ["浅色", "深色", "跟随系统"],
  "target": "theme",
  "multi": false
}
```

**多选示例：**
```json
{
  "node": "select",
  "title": "选择功能",
  "items": ["自动保存", "语法高亮", "代码补全"],
  "target": "features",
  "multi": true
}
```

**参数：**
- `title` - 对话框标题
- `items` - 选项数组
- `target` - 保存到哪个变量（多选时用逗号分隔）
- `multi` - 是否多选，`true` 或 `false`

---

### 5. if - 条件判断

根据变量值决定执行哪个分支。

```json
{
  "node": "if",
  "var": "theme",
  "type": "==",
  "value": "深色",
  "success": [
    {"node": "alert", "title": "提示", "message": "你选择了深色主题"}
  ],
  "error": [
    {"node": "alert", "title": "提示", "message": "你选择了其他主题"}
  ]
}
```

**参数：**
- `var` - 要判断的变量名
- `type` - 判断类型
- `value` - 比较值（部分类型不需要）
- `success` - 条件成立时执行的节点数组
- `error` - 条件不成立时执行的节点数组

**判断类型：**
| type | 说明 | 示例 |
|------|------|------|
| `==` | 等于 | `theme == "深色"` |
| `!=` | 不等于 | `theme != "浅色"` |
| `contains` | 包含 | `features` 包含 `"自动保存"` |
| `empty` | 为空 | `nickname` 是空的 |
| `not_empty` | 不为空 | `nickname` 不是空的 |

---

### 6. command - 执行命令

执行 shell 命令。

```json
{
  "node": "command",
  "sh": "mkdir -p ${plugin_path}/data"
}
```

**参数：**
- `sh` - 要执行的命令

---

### 7. command_result - 执行命令并获取结果

执行命令，根据执行结果（成功/失败）执行不同分支。

```json
{
  "node": "command_result",
  "sh": "ndk-build",
  "dir": "${current_dir}",
  "success": [
    {"node": "alert", "title": "成功", "message": "编译完成！\n${cmd_output}"}
  ],
  "error": [
    {"node": "alert", "title": "失败", "message": "编译失败！\n${cmd_error}"}
  ]
}
```

**参数：**
- `sh` - 要执行的命令
- `dir` - 工作目录（可选，默认为插件目录）
- `success` - 命令成功时执行的节点数组
- `error` - 命令失败时执行的节点数组

**执行后设置的变量：**
- `${cmd_output}` - 命令成功时的输出
- `${cmd_error}` - 命令失败时的错误信息
- `${cmd_exit_code}` - 命令退出码

---

### 8. add_path - 添加环境变量

将路径添加到系统 PATH，终端和编译时可用。

```json
{
  "node": "add_path",
  "export": "${plugin_path}/bin"
}
```

**参数：**
- `export` - 要添加的路径（多个用 `:` 分隔）

---

### 9. grep - 正则表达式匹配

从输入文本中提取匹配正则表达式的内容。

```json
{
  "node": "grep",
  "input": "${cmd_output}",
  "pattern": "=> (libs/[^\\s]+)",
  "target": "matched_files",
  "group": 1
}
```

**参数：**
- `input` - 输入文本（通常是命令输出）
- `pattern` - 正则表达式
- `target` - 保存匹配结果的变量名（多个结果用逗号分隔）
- `group` - 捕获组索引（0 表示整个匹配，1 表示第一个括号捕获组）

**示例：** 从 NDK 编译输出中提取生成的文件路径
```
输入：[arm64-v8a] Install : memory => libs/arm64-v8a/memory
正则：=> (libs/[^\s]+)
结果：libs/arm64-v8a/memory
```

---

### 10. run_in_terminal - 在终端运行文件

打开终端并运行指定的可执行文件。

```json
{
  "node": "run_in_terminal",
  "file": "${plugin_path}/tmp/my_program",
  "args": "-v --debug"
}
```

**参数：**
- `file` - 可执行文件的绝对路径
- `args` - 运行参数（可选）

---

## 完整示例

### 示例1：简单提示

安装前显示欢迎信息：

```json
{
  "install_before": [
    {
      "node": "alert",
      "title": "欢迎",
      "message": "感谢使用本插件！\n点击确定开始安装"
    }
  ]
}
```

---

### 示例2：用户输入 + 条件判断

让用户输入昵称，如果为空则使用默认值：

```json
{
  "install_before": [
    {
      "node": "create_value",
      "name": "nickname",
      "type": "string",
      "value": ""
    },
    {
      "node": "edit",
      "title": "设置昵称",
      "hint": "请输入昵称（可留空）",
      "target": "nickname",
      "default": ""
    },
    {
      "node": "if",
      "var": "nickname",
      "type": "empty",
      "success": [
        {
          "node": "create_value",
          "name": "nickname",
          "type": "string",
          "value": "匿名用户"
        }
      ]
    },
    {
      "node": "alert",
      "title": "你好",
      "message": "欢迎你，${nickname}！"
    }
  ]
}
```

---

### 示例3：单选 + 分支处理

让用户选择安装模式：

```json
{
  "install_before": [
    {
      "node": "select",
      "title": "安装模式",
      "items": ["快速安装", "自定义安装"],
      "target": "mode",
      "multi": false
    },
    {
      "node": "if",
      "var": "mode",
      "type": "==",
      "value": "自定义安装",
      "success": [
        {
          "node": "select",
          "title": "选择组件",
          "items": ["核心功能", "扩展工具", "示例代码", "文档"],
          "target": "components",
          "multi": true
        },
        {
          "node": "alert",
          "title": "已选择",
          "message": "将安装以下组件：\n${components}"
        }
      ],
      "error": [
        {
          "node": "alert",
          "title": "快速安装",
          "message": "将安装全部组件"
        }
      ]
    }
  ]
}
```

---

### 示例4：完整安装流程

```json
{
  "install_before": [
    {
      "node": "alert",
      "title": "安装向导",
      "message": "欢迎使用 MyTool 插件！\n\n本插件提供以下功能：\n• 代码格式化\n• 语法检查\n• 快捷编译"
    },
    {
      "node": "select",
      "title": "选择语言",
      "items": ["简体中文", "English"],
      "target": "lang",
      "multi": false
    }
  ],
  "install_start": [
    {
      "node": "command",
      "sh": "cd ${plugin_path} && unzip -o data.zip"
    },
    {
      "node": "command",
      "sh": "chmod +x ${plugin_path}/bin/*"
    }
  ],
  "install_after": [
    {
      "node": "add_path",
      "export": "${plugin_path}/bin"
    },
    {
      "node": "alert",
      "title": "安装完成",
      "message": "插件安装成功！\n\n语言：${lang}\n\n现在可以在终端中使用 mytool 命令了"
    }
  ]
}
```

---

## 注意事项

1. 所有文本都支持使用 `${变量名}` 引用变量
2. `if` 节点的 `success` 和 `error` 分支可以嵌套任意节点
3. 用户点击取消时，输入框和选择框不会修改目标变量
4. `command` 节点的工作目录是插件目录
5. 多选结果用英文逗号 `,` 分隔


---

# 插件 Hook 系统文档

插件可以通过 `.hook` 文件定义钩子，在特定事件发生时执行自定义操作。

## 文件结构

```json
{
  "toolbar": [...],    // 工具栏按钮
  "menu": [...],       // 菜单项
  "run_menu": [...],   // 运行按钮下拉菜单项
  "events": {          // 事件钩子
    "on_compile_before": [...],
    "on_compile_success": [...],
    "on_compile_error": [...],
    "on_run_before": [...],
    "on_app_init": [...]
  }
}
```

---

## 工具栏按钮

在编辑器工具栏添加自定义按钮。

```json
{
  "toolbar": [
    {
      "icon": "ic_format",
      "label": "格式化",
      "position": "left:2",
      "onClick": [
        {"node": "command", "sh": "clang-format -i ${source_file}"}
      ],
      "onLongClick": [
        {"node": "alert", "title": "提示", "message": "长按了格式化按钮"}
      ]
    }
  ]
}
```

**参数：**
- `icon` - 图标名称
- `label` - 按钮标签
- `position` - 位置：`left:N` 或 `right:N`（N 为索引）
- `onClick` - 点击时执行的节点数组
- `onLongClick` - 长按时执行的节点数组

---

## 菜单项

在编辑器右上角菜单添加自定义项。

```json
{
  "menu": [
    {
      "title": "运行测试",
      "position": "after:运行",
      "onClick": [
        {"node": "command", "sh": "cd ${plugin_path} && ./run_test.sh"}
      ]
    }
  ]
}
```

**参数：**
- `title` - 菜单项标题
- `position` - 位置：`start`（开头）、`end`（结尾）、`after:菜单名`（指定菜单后）
- `onClick` - 点击时执行的节点数组

---

## 运行菜单项

在运行按钮的下拉菜单中添加自定义项（点击运行按钮右侧箭头展开）。

```json
{
  "run_menu": [
    {
      "title": "NDK 编译运行",
      "icon": "PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBmaWxsPSIjNEVDOUIwIiBkPSJNOCA1djE0bDExLTd6Ii8+PC9zdmc+",
      "position": "start",
      "onClick": [
        {"node": "command_result", "sh": "ndk-build", "dir": "${current_dir}", 
         "success": [{"node": "run_in_terminal", "file": "${current_dir}/libs/arm64-v8a/main"}],
         "error": [{"node": "alert", "title": "编译失败", "message": "${cmd_error}"}]
        }
      ]
    }
  ]
}
```

**参数：**
- `title` - 菜单项标题
- `icon` - 图标（Base64 编码的 SVG 字符串，可选）
- `position` - 位置：`start`（在默认运行项之前）、`end`（在默认运行项之后，默认值）
- `onClick` - 点击时执行的节点数组

---

## 事件钩子

### on_compile_before - 编译前

编译开始前执行。

**可用变量：**
- `${source_file}` - 源文件路径
- `${output_file}` - 输出文件路径

```json
{
  "events": {
    "on_compile_before": [
      {"node": "alert", "title": "编译", "message": "开始编译 ${source_file}"}
    ]
  }
}
```

---

### on_compile_success - 编译成功

编译成功后执行。

**可用变量：**
- `${source_file}` - 源文件路径
- `${output_file}` - 输出文件路径
- `${compile_time}` - 编译耗时

```json
{
  "events": {
    "on_compile_success": [
      {"node": "command", "sh": "echo '编译成功' >> ${plugin_path}/log.txt"}
    ]
  }
}
```

---

### on_compile_error - 编译失败

编译失败后执行。

**可用变量：**
- `${source_file}` - 源文件路径
- `${error_message}` - 错误信息

```json
{
  "events": {
    "on_compile_error": [
      {"node": "alert", "title": "编译失败", "message": "错误：${error_message}"}
    ]
  }
}
```

---

### on_run_before - 运行前

程序运行前执行。

**可用变量：**
- `${run_file}` - 运行文件路径
- `${run_args}` - 运行参数

```json
{
  "events": {
    "on_run_before": [
      {"node": "command", "sh": "echo '运行 ${run_file}' >> ${plugin_path}/log.txt"}
    ]
  }
}
```

---

### on_app_init - 应用初始化

应用启动时执行（注意：此时可能没有 Activity 上下文，不建议使用 UI 相关节点）。

```json
{
  "events": {
    "on_app_init": [
      {"node": "command", "sh": "mkdir -p ${plugin_path}/cache"}
    ]
  }
}
```

---

## 完整示例

### 示例1：代码格式化插件

```json
{
  "toolbar": [
    {
      "icon": "ic_format",
      "label": "格式化",
      "position": "right:0",
      "onClick": [
        {"node": "command", "sh": "${plugin_path}/bin/clang-format -i ${source_file}"},
        {"node": "alert", "title": "完成", "message": "代码格式化完成"}
      ]
    }
  ]
}
```

---

### 示例2：编译日志插件

```json
{
  "events": {
    "on_compile_before": [
      {"node": "command", "sh": "echo '[$(date)] 开始编译 ${source_file}' >> ${plugin_path}/compile.log"}
    ],
    "on_compile_success": [
      {"node": "command", "sh": "echo '[$(date)] 编译成功，耗时 ${compile_time}' >> ${plugin_path}/compile.log"}
    ],
    "on_compile_error": [
      {"node": "command", "sh": "echo '[$(date)] 编译失败' >> ${plugin_path}/compile.log"}
    ]
  }
}
```

---

### 示例3：自定义菜单

```json
{
  "menu": [
    {
      "title": "清理缓存",
      "position": "end",
      "onClick": [
        {"node": "command", "sh": "rm -rf ${cache_dir}/tmp/*"},
        {"node": "alert", "title": "完成", "message": "缓存已清理"}
      ]
    },
    {
      "title": "查看日志",
      "position": "end",
      "onClick": [
        {"node": "command", "sh": "cat ${plugin_path}/log.txt"}
      ]
    }
  ]
}
```

---

## 注意事项

1. 所有事件的值都是节点数组，支持 `.install` 文件中的所有节点类型
2. 多个插件的同一事件会依次执行
3. 插件启用/禁用后，hook 会自动重新加载
4. 内置变量（如 `${plugin_path}`）在所有 hook 中都可用
5. 事件特有变量（如 `${source_file}`）只在对应事件中可用
